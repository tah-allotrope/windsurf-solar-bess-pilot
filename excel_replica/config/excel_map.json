{
  "Calc": {
    "AllowDischarge": "=IF(\n  Strategy_mode=1,\n  _xlfn.LET(\n    _xlpm.ts,$A2,\n    _xlpm.hourfrac,HOUR(_xlpm.ts)+MINUTE(_xlpm.ts)/60,\n    _xlpm.isPeak, $E2=\"P\",\n    _xlpm.isSunday, WEEKDAY(_xlpm.ts,2)=7,\n    _xlpm.optStart, OptimizeStartHour,\n    _xlpm.optEnd,   OptimizeEndHour,\n    _xlpm.condWhen, --(When_Needed=1),\n    _xlpm.condAfter,--(AND(After_Sunset=1, _xlpm.hourfrac>17)),\n    _xlpm.condOpt,  --(AND(Optimize_mode_1=1, OR(AND(_xlpm.hourfrac>=_xlpm.optStart,_xlpm.hourfrac<_xlpm.optEnd), _xlpm.isPeak, AND(_xlpm.isSunday, _xlpm.hourfrac>15, _xlpm.hourfrac<=20)))),\n    _xlpm.condPeak, --(AND(Peak=1, OR(_xlpm.isPeak, AND(_xlpm.isSunday, OR(AND(_xlpm.hourfrac>4, _xlpm.hourfrac<9), AND(_xlpm.hourfrac>16, _xlpm.hourfrac<=20)))))),\n    IF(_xlpm.condWhen+_xlpm.condAfter+_xlpm.condOpt+_xlpm.condPeak>0,1,0)\n  ),\n  _xlfn.LET(\n    _xlpm.demandTarget_kW, $AK2,\n    _xlpm.grid_kW,         $AI2,\n    IF(_xlpm.grid_kW > _xlpm.demandTarget_kW, 1, 0)\n  )\n)",
    "BAU_GridEnergyExpense": "= $D2 * StepHours *\n  _xlfn.SWITCH(\n    $E2,\n    \"P\", Ca_peak,\n    \"O\", Ca_offpeak,\n    \"N\", Ca_normal,\n0\n  )",
    "BESSSaving": "=AG2-AE2",
    "Blance_Check": "=F2-(I2+Q2*StepHours+Z2)",
    "ChargeLimit_kWh": "=MIN(Total_BESS_Power_Output*StepHours, O2/Charge_discharge_efficiency)",
    "CleanLoadServed_kWh": "=I2*StepHours+Q2*Charge_discharge_efficiency^2",
    "CombinrSystemSaving": "=AC2-AD2",
    "Date": "=DAY(A2)",
    "Delta": "=M3-M2",
    "DemandTarget_kW": "=_xlfn.LET(\n  _xlpm.ts, $A2,\n  _xlpm.mKey, MONTH(_xlpm.ts),\n  _xlfn.XLOOKUP(\n    _xlpm.mKey,\n    DemandTargetTbl[Month],\n    DemandTargetTbl[Demand_Target_kW]\n  )\n)",
    "DirectPVConsumption_kW": "=MIN( $D2, MAX($F2 - $G2, 0) )",
    "DirectPVEnergySaving": "=$I2*StepHours *\n  _xlfn.SWITCH(\n    $E2,\n    \"P\", Ca_peak,\n    \"O\", Ca_offpeak,\n    \"N\", Ca_normal,\n0\n  )",
    "DischargeConditionFlag": "=IF(\n  Strategy_mode=1,\n  IF(OR($J2=0,$H2>0),0,1),\n  IF(\n    Strategy_mode=2,\n    IF(\n      AND($E2=\"P\", $AM2 >= PeakShave_DeepStartHour),\n      3,\n      IF($J2=1, 2, 0)\n    ),\n    0\n  )\n)",
    "DischargeEnergy_kWh": "=V2*StepHours",
    "DischargePower_kW": "=_xlfn.LET(\n  _xlpm.mode, Strategy_mode,\n  _xlpm.flag, $U2,\n  _xlpm.eta,  Charge_discharge_efficiency,\n  _xlpm.dt,   StepHours,\n  _xlpm.soc,  $M2,\n  _xlpm.pmax, Total_BESS_Power_Output,\n  _xlpm.hdrv_kWh, -$H2*_xlpm.dt,\n  _xlpm.grid,   $AI2,\n  _xlpm.target, $AK2,\n  _xlpm.minRes, Min_Reserve_SOC,\n  _xlpm.shave_req_kWh,   MAX((_xlpm.grid - _xlpm.target)*_xlpm.dt, 0),\n  _xlpm.deep_margin_kWh, MAX((_xlpm.soc - _xlpm.minRes)*_xlpm.eta, 0),\n  IF(\n    _xlpm.flag=0,\n      0,\n      IF(\n        _xlpm.mode=1,\n          MIN( _xlpm.hdrv_kWh, _xlpm.pmax*_xlpm.dt, _xlpm.soc*_xlpm.eta ),\n        IF(\n          _xlpm.mode=2,\n            _xlfn.SWITCH(\n              _xlpm.flag,\n              2, MIN( _xlpm.shave_req_kWh,  _xlpm.pmax*_xlpm.dt, _xlpm.soc*_xlpm.eta ),\n              3, MIN( _xlpm.pmax*_xlpm.dt,        _xlpm.deep_margin_kWh, _xlpm.grid ),\n              0\n            ),0))\n  )\n)",
    "ExcessSolarAvailable_kW": "=MAX( ($F2 - $G2) - $D2, 0 )",
    "GridChargeAllowFlag": "=_xlfn.LET(\n  _xlpm.ts,$A2,\n  _xlpm.hourfrac,HOUR(_xlpm.ts)+MINUTE(_xlpm.ts)/60,\n  _xlpm.isOff, $E2=\"O\",\n  _xlpm.notSun, WEEKDAY(_xlpm.ts,2)<>7,\n  _xlpm.startH, GridChargeStartHour,\n  _xlpm.endH,   GridChargeEndHour,\n  _xlpm.isAllowed, Charge_by_Grid=1,\n  IF(AND(_xlpm.isAllowed,_xlpm.isOff,_xlpm.notSun),1,\n     IF(AND(_xlpm.isAllowed,_xlpm.notSun,_xlpm.hourfrac>=_xlpm.startH,_xlpm.hourfrac<=_xlpm.endH),2,0))\n)",
    "GridCharged_kWh": "=_xlfn.LET(\n  _xlpm.usable,  Usable_BESS_Capacity,\n  _xlpm.capGrid, CapGrid,\n  _xlpm.soc,     $M2,\n  _xlpm.flag,    $K2,\n  _xlpm.pv,      $Q2,\n  _xlpm.lim,     $P2,\n  _xlpm.rem,     MAX(_xlpm.lim - _xlpm.pv, 0),\n  _xlpm.eta,     Charge_discharge_efficiency,\n  IF(Does_BESS_System_include_?=0, 0,\n     IF(_xlpm.flag=1,\n        MIN(_xlpm.rem, MAX((_xlpm.capGrid - _xlpm.soc)/_xlpm.eta, 0)),\n        IF(_xlpm.flag=2, _xlpm.rem, 0)\n     )\n  )\n)",
    "GridLoadAfterSolar+BESS_kW": "=IF(X2>0,X2+S2/StepHours,0)",
    "GridLoadafterSolar_kW": "=ABS(MIN(H2,0))",
    "Headroom_kWh": "=MAX(0, Usable_BESS_Capacity - M2)",
    "Hours": "=HOUR($A2)+MINUTE($A2)/60",
    "Month": "=MONTH(A2)",
    "NetCleanEnergyUsed_kWh": "=I2*StepHours+W2-S2",
    "NetGenForDPPA_kW": "=F2-Q2/StepHours+V2",
    "NetLoadAfterSolar+BESS": "=D2-F2-V2",
    "NetLoadAfterSolar_kW": "=IFERROR($F2 - $D2, 0)",
    "PVActive2BESS_kW": "=_xlfn.LET(\n  _xlpm.ts, $A2,\n  _xlpm.hr, HOUR(_xlpm.ts)+MINUTE(_xlpm.ts)/60,\n  _xlpm.isPeak, $E2=\"P\",\n  _xlpm.dt, StepHours,\n  _xlpm.eta, Charge_discharge_efficiency,\n  _xlpm.pv_kW, $F2,\n  _xlpm.load_kW, $D2,\n\n  _xlpm.min2Load_kW, Min_DirectPVShare * _xlpm.load_kW,\n  _xlpm.cap_kW, IF(Does_BESS_System_include_?=0, 0, $P2 / _xlpm.dt),\n\n  _xlpm.inWin1, IF(ActivePV2BESS_StartHour<=ActivePV2BESS_EndHour,\n             (_xlpm.hr>=ActivePV2BESS_StartHour)*(_xlpm.hr<ActivePV2BESS_EndHour),\n             OR(_xlpm.hr>=ActivePV2BESS_StartHour, _xlpm.hr<ActivePV2BESS_EndHour)),\n  _xlpm.req1_kW, IF(AND(ActivePV2BESS_Mode=1, _xlpm.inWin1, NOT(_xlpm.isPeak), ActivePV2BESS_Share>0),\n              _xlpm.pv_kW * ActivePV2BESS_Share, 0),\n\n  _xlpm.gap_kWh, MAX(Precharge_TargetSoC_kWh - $M2, 0),\n  _xlpm.inWin2, AND(ActivePV2BESS_Mode=2, NOT(_xlpm.isPeak), _xlpm.hr < Precharge_TargetHour),\n  _xlpm.req2_kW, IF(_xlpm.inWin2, _xlpm.gap_kWh / (_xlpm.eta * _xlpm.dt), 0),\n\n  _xlpm.req_raw_kW, _xlfn.SWITCH(ActivePV2BESS_Mode, 1, _xlpm.req1_kW, 2, _xlpm.req2_kW, 0),\n\n  _xlpm.divertable_kW, MAX(_xlpm.pv_kW - _xlpm.min2Load_kW, 0),\n  _xlpm.req_div_kW, MAX( MIN(_xlpm.req_raw_kW, _xlpm.divertable_kW), 0 ),\n\n  MIN(_xlpm.req_div_kW, _xlpm.cap_kW)\n)",
    "PVCharged_kWh": "=_xlfn.LET(\n  _xlpm.dt, StepHours,\n  _xlpm.cap_kW, $P2/_xlpm.dt,\n  _xlpm.act_kW, $G2,\n  _xlpm.rem_kW, MAX(_xlpm.cap_kW - _xlpm.act_kW, 0),\n  _xlpm.exs_kW, MAX( ($F2 - _xlpm.act_kW) - $D2, 0 ),\n  ( _xlpm.act_kW + MIN(_xlpm.exs_kW, _xlpm.rem_kW) ) * _xlpm.dt\n)",
    "PowerSurplus_kW": "=G2+L2-Q2/StepHours",
    "RE_GridEnergyExpense": "=$Y2*StepHours *\n  _xlfn.SWITCH(\n    $E2,\n    \"P\", Ca_peak,\n    \"O\", Ca_offpeak,\n    \"N\", Ca_normal,\n0\n  )",
    "SimulationProfile_kW": "=_xlfn.LET(\n  _xlpm.ret,\n  _xlfn.XLOOKUP($A2, SimulationData[DateTime], _xlfn.CHOOSECOLS(SimulationData[], {2,3,4}), 0, 0, 2),\n  _xlpm.ret\n)",
    "SolarGen_kW": "=IFERROR($B2 * Output_Scale_Factor, 0)",
    "Solar_GridEnergyExpense": "= $AI2 * StepHours *\n  _xlfn.SWITCH(\n    $E2,\n    \"P\", Ca_peak,\n    \"O\", Ca_offpeak,\n    \"N\", Ca_normal,\n0\n  )",
    "TimePeriodFlag": "=_xlfn.LET(\n  _xlpm.ts,$A2,\n  _xlpm.wd,WEEKDAY(_xlpm.ts,2),\n  _xlpm.m,HOUR(_xlpm.ts)*60+MINUTE(_xlpm.ts),\n  _xlpm.off, (_xlpm.m>=1320)+(_xlpm.m<240),\n  _xlpm.peak,(_xlpm.wd<=6)*(((_xlpm.m>=570)*(_xlpm.m<690))+((_xlpm.m>=1020)*(_xlpm.m<1200))),\n  _xlpm.code, IF(_xlpm.off,1, IF(_xlpm.peak,3,2)),\n  INDEX({\"O\",\"N\",\"P\"}, _xlpm.code)\n)",
    "TotalBESSCharged_kWh": "=Q2+S2"
  },
  "DPPA": {
    "BAU_Expense": "= B2 * _xlfn.XLOOKUP(\n    E2,\n    RetailTariff[Voltage Level],\n    _xlfn.CHOOSECOLS(RetailTariff[], IF(DPPA_Connection_Voltage_Level=110, 3, 2))\n)",
    "CCL": "=I2*PCL",
    "CDN": "=I2*D2*Kpp",
    "C_BL": "= M2 * _xlfn.XLOOKUP(\n    E2,\n    RetailTariff[Voltage Level],\n    _xlfn.CHOOSECOLS(RetailTariff[], IF(DPPA_Connection_Voltage_Level=110, 3, 2))\n)",
    "C_DPPA": "=I2*CDPPAdv",
    "C_KH": "=J2+K2+L2+N2",
    "DeliveredREGen_Qm": "=F2/(k_factor*Kpp)*Delta",
    "Load": "=IF(Does_model_is_actived?,\n    _xlfn.LET(\n        _xlpm.ret,\n        _xlfn.XLOOKUP($A2, SimulationData[DateTime], _xlfn.CHOOSECOLS(SimulationData[],{4,5,6}), 0, 0, 2),\n        _xlpm.ret\n    ),\n    {0,0,0}\n)",
    "NetGeneration_Qmq": "=IF(Does_model_is_actived?=1,\n   _xlfn.XLOOKUP($A2, Calc!$A$2:$A$8761, Calc!$AB$2:$AB$8761, 0, 0, 2),\n   0\n)",
    "PriceSpreadSettlement": "=I2*S2",
    "PriceSpread_Adj": "=D2*Kpp-C2",
    "Q_BL": "=B2-I2",
    "Q_Khc": "=MIN(B2,H2)",
    "R_CFD": "=I2*(Strike_Price-C2)",
    "R_total": "=G2+P2",
    "Rg": "=F2*C2",
    "Surplus": "=H2-I2",
    "SurplusMarketRevenue": "=U2*C2",
    "TimePeriodFlag": "=_xlfn.XLOOKUP($A2, Calc!$A$2:$A$8761, Calc!$E$2:$E$8761, 0, 0, 2)"
  },
  "Lifetime": {
    "1": "=Total_Solar_Generation*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "10": "=Total_Solar_Generation*_xlfn.XLOOKUP(K$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "11": "=Total_Solar_Generation*_xlfn.XLOOKUP(L$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "12": "=Total_Solar_Generation*_xlfn.XLOOKUP(M$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "13": "=Total_Solar_Generation*_xlfn.XLOOKUP(N$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "14": "=Total_Solar_Generation*_xlfn.XLOOKUP(O$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "15": "=Total_Solar_Generation*_xlfn.XLOOKUP(P$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "16": "=Total_Solar_Generation*_xlfn.XLOOKUP(Q$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "17": "=Total_Solar_Generation*_xlfn.XLOOKUP(R$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "18": "=Total_Solar_Generation*_xlfn.XLOOKUP(S$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "19": "=Total_Solar_Generation*_xlfn.XLOOKUP(T$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "2": "=Total_Solar_Generation*_xlfn.XLOOKUP(C$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "20": "=Total_Solar_Generation*_xlfn.XLOOKUP(U$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "21": "=Total_Solar_Generation*_xlfn.XLOOKUP(V$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "22": "=Total_Solar_Generation*_xlfn.XLOOKUP(W$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "23": "=Total_Solar_Generation*_xlfn.XLOOKUP(X$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "24": "=Total_Solar_Generation*_xlfn.XLOOKUP(Y$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "25": "=Total_Solar_Generation*_xlfn.XLOOKUP(Z$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "3": "=Total_Solar_Generation*_xlfn.XLOOKUP(D$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "4": "=Total_Solar_Generation*_xlfn.XLOOKUP(E$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "5": "=Total_Solar_Generation*_xlfn.XLOOKUP(F$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "6": "=Total_Solar_Generation*_xlfn.XLOOKUP(G$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "7": "=Total_Solar_Generation*_xlfn.XLOOKUP(H$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "8": "=Total_Solar_Generation*_xlfn.XLOOKUP(I$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "9": "=Total_Solar_Generation*_xlfn.XLOOKUP(J$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "BESS ConvLoss Annual": "=Usable_BESS_Capacity*365*System_Availability*Measures!$D$22*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "BESSContribution_pct": "=B4/B7",
    "BESSToLoad_MWh": "=BESS_To_Load*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "BESSToLoad_OffPeak_MWh": "=BESStoLoad_Off_Peak*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "BESSToLoad_Peak_MWh": "=BESStoLoad_Peak*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "BESSToLoad_Std_MWh": "=BESStoLoad_Std*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "CleanEnergyShare_pct": "=B5/B7",
    "ExcessSolarExport_MWh": "=PV_Surplus*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "GridEnergyUse_MWh": "=B7-B5+B18",
    "GridSupplyShare_pct": "=B6/B7",
    "GridToBESS_MWh": "=Grid_To_BESS*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "GridToBESS_Normal_MWh": "=GridtoBESS_Std*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "GridToBESS_OffPeak_MWh": "=GridtoBESS_Off_Peak*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$F$3:$F$27,0,0)/1000",
    "NetSolarToBESS_MWh": "=B21*Charge_discharge_efficiency",
    "NonGridEnergyUse_MWh": "=B3+B4",
    "Q_Khc": "=Measures!$G$11*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "SolarGen_MWh": "=Total_Solar_Generation*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "SolarOffset_pct": "=B3/B7",
    "SolarToBESS_MWh": "=Solar_To_BESS*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "SolarToLoad_MWh": "=Direct_PV_Consumption*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "SolarToLoad_Peak_MWh": "=Direct_PV_Peak*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "SolarToLoad_Std_MWh": "=Direct_PV_Std*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "Surplus": "=Measures!$G$17*_xlfn.XLOOKUP(B$1,Loss!$A$3:$A$27,Loss!$E$3:$E$27,0,0)/1000",
    "TotalLoad_MWh": "=Total_Factory_Load/1000"
  }
}